generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String             @id @default(cuid())
  name                  String
  email                 String             @unique
  password              String
  role                  UserRole
  phone                 String?
  address               String?
  city                  String?
  province              String?
  country               String             @default("Rwanda")
  cooperativeId         String?
  registrationNumber    String?
  isActive              Boolean            @default(true)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  publicHash            String?            @unique @map("public_hash")
  phoneHash             String?            @map("phone_hash")
  aidApplications       AidParticipant[]
  authoredAnnouncements Announcement[]
  uploadedDocuments     BatchDocument[]
  batchHistory          BatchHistory[]
  comments              Comment[]
  donationsReceived     Donation[]
  exportRecords         ExportRecord[]
  naebReports           NAEBReport[]
  notifications         Notification[]
  paymentsReceived      Payment[]          @relation("PaymentsReceived")
  paymentsMade          Payment[]          @relation("PaymentsMade")
  votes                 PollVote[]
  createdPolls          Poll[]
  processingRecords     ProcessingRecord[]
  exporterBatches       ProductBatch[]     @relation("ExporterBatches")
  factoryBatches        ProductBatch[]     @relation("FactoryBatches")
  farmerBatches         ProductBatch[]     @relation("FarmerBatches")
  importerBatches       ProductBatch[]     @relation("ImporterBatches")
  retailerBatches       ProductBatch[]     @relation("RetailerBatches")
  washingStationBatches ProductBatch[]     @relation("WashingStationBatches")
  events                SupplyChainEvent[]
  threads               Thread[]
  cooperative           Cooperative?       @relation(fields: [cooperativeId], references: [id])

  @@index([role])
  @@index([cooperativeId])
  @@map("users")
}

model Cooperative {
  id            String         @id @default(cuid())
  name          String         @unique
  location      String
  description   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  aidPrograms   AidProgram[]
  announcements Announcement[]
  polls         Poll[]
  batches       ProductBatch[]
  threads       Thread[]
  farmers       User[]

  @@map("cooperatives")
}

model ProductBatch {
  id                String             @id @default(cuid())
  type              ProductType
  status            BatchStatus        @default(pending)
  originLocation    String
  region            String?
  district          String?
  sector            String?
  cell              String?
  village           String?
  coordinates       String?
  lotId             String?            @unique
  quantity          Float?
  quality           String?
  moisture          Float?
  harvestDate       DateTime?
  processingType    String?
  grade             String?
  teaType           String?
  pluckingDate      DateTime?
  qrCode            String?            @unique
  qrCodeGeneratedAt DateTime?
  verificationUrl   String?
  qrCodeUrl         String?            @map("qr_code_url")
  publicTraceHash   String?            @unique @map("public_trace_hash")
  currentStage      SupplyChainStage
  blockchainTxHash  String?
  nftPolicyId       String?
  nftAssetName      String?
  nftMintedAt       DateTime?
  description       String?
  metadata          Json?
  tags              String[]
  deletedAt         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  farmerId          String?
  washingStationId  String?
  factoryId         String?
  exporterId        String?
  importerId        String?
  retailerId        String?
  cooperativeId     String?
  documents         BatchDocument[]
  history           BatchHistory[]
  integrity         BatchIntegrity?
  certificates      Certificate[]
  exportRecord      ExportRecord?
  payments          Payment[]
  processingRecords ProcessingRecord[]
  cooperative       Cooperative?       @relation(fields: [cooperativeId], references: [id])
  exporter          User?              @relation("ExporterBatches", fields: [exporterId], references: [id])
  factory           User?              @relation("FactoryBatches", fields: [factoryId], references: [id])
  farmer            User?              @relation("FarmerBatches", fields: [farmerId], references: [id])
  importer          User?              @relation("ImporterBatches", fields: [importerId], references: [id])
  retailer          User?              @relation("RetailerBatches", fields: [retailerId], references: [id])
  washingStation    User?              @relation("WashingStationBatches", fields: [washingStationId], references: [id])
  ratings           Rating[]
  events            SupplyChainEvent[]

  @@index([status, deletedAt])
  @@index([description])
  @@index([farmerId])
  @@index([washingStationId])
  @@index([cooperativeId])
  @@index([factoryId])
  @@index([exporterId])
  @@index([importerId])
  @@index([retailerId])
  @@index([farmerId, createdAt])
  @@map("product_batches")
}

model BatchHistory {
  id               String           @id @default(cuid())
  batchId          String
  stage            SupplyChainStage
  blockchainTxHash String?
  timestamp        DateTime         @default(now())
  changedBy        String
  notes            String?
  quantity         Float?
  quality          String?
  location         String?
  metadata         Json?
  batch            ProductBatch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [changedBy], references: [id])

  @@map("batch_history")
}

model ProcessingRecord {
  id               String           @id @default(cuid())
  batchId          String
  stage            SupplyChainStage
  processingType   String
  notes            String?
  qualityScore     Float?
  quantityIn       Float?
  quantityOut      Float?
  processedBy      String
  processedAt      DateTime         @default(now())
  blockchainTxHash String?
  batch            ProductBatch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  processor        User             @relation(fields: [processedBy], references: [id])

  @@map("processing_records")
}

model Payment {
  id               String        @id @default(cuid())
  batchId          String
  payerId          String
  payeeId          String
  amount           Decimal
  currency         String        @default("RWF")
  paymentType      PaymentType
  status           PaymentStatus @default(pending)
  paymentDate      DateTime?
  transactionRef   String?
  notes            String?
  blockchainTxHash String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  batch            ProductBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  payee            User          @relation("PaymentsReceived", fields: [payeeId], references: [id])
  payer            User          @relation("PaymentsMade", fields: [payerId], references: [id])

  @@map("payments")
}

model ExportRecord {
  id               String       @id @default(cuid())
  batchId          String       @unique
  exporterId       String
  buyerName        String
  buyerAddress     String?
  buyerEmail       String?
  shippingMethod   String
  shippingDate     DateTime
  expectedArrival  DateTime?
  trackingNumber   String?
  certificates     String?
  blockchainTxHash String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  batch            ProductBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  exporter         User         @relation(fields: [exporterId], references: [id])

  @@map("export_records")
}

model Certificate {
  id                String          @id @default(cuid())
  batchId           String
  certificateType   CertificateType
  certificateNumber String          @unique
  issuedBy          String
  issuedDate        DateTime
  expiryDate        DateTime?
  documentUrl       String?
  blockchainTxHash  String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  batch             ProductBatch    @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("certificates")
}

model NAEBReport {
  id              String       @id @default(cuid())
  reportType      ReportType
  periodStart     DateTime
  periodEnd       DateTime
  generatedBy     String
  data            Json
  status          ReportStatus @default(draft)
  submittedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  generatedByUser User         @relation(fields: [generatedBy], references: [id])

  @@map("naeb_reports")
}

model BatchIntegrity {
  id         String       @id @default(cuid())
  batchId    String       @unique
  hash       String
  frozenData Json
  createdAt  DateTime     @default(now())
  batch      ProductBatch @relation(fields: [batchId], references: [id])

  @@map("batch_integrity")
}

model SupplyChainEvent {
  id          String       @id @default(cuid())
  batchId     String
  eventType   String
  timestamp   DateTime     @default(now())
  operatorId  String
  location    String?
  description String?
  metadata    Json?
  eventHash   String?
  batch       ProductBatch @relation(fields: [batchId], references: [id])
  operator    User         @relation(fields: [operatorId], references: [id])

  @@map("supply_chain_events")
}

model BatchDocument {
  id         String       @id @default(cuid())
  batchId    String
  type       String
  url        String
  hash       String
  uploadedBy String
  createdAt  DateTime     @default(now())
  batch      ProductBatch @relation(fields: [batchId], references: [id])
  uploader   User         @relation(fields: [uploadedBy], references: [id])

  @@map("batch_documents")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  isRead    Boolean   @default(false)
  smsSent   Boolean   @default(false)
  emailSent Boolean   @default(false)
  createdAt DateTime  @default(now())
  readAt    DateTime?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Announcement {
  id            String           @id @default(uuid())
  title         String
  content       String
  type          AnnouncementType
  priority      String           @default("normal")
  cooperativeId String?
  authorId      String
  publishedAt   DateTime         @default(now())
  expiresAt     DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  author        User             @relation(fields: [authorId], references: [id])
  cooperative   Cooperative?     @relation(fields: [cooperativeId], references: [id])
  comments      Comment[]

  @@index([cooperativeId, publishedAt])
  @@map("announcements")
}

model Poll {
  id            String       @id @default(uuid())
  title         String
  description   String?
  pollType      PollType
  cooperativeId String?
  createdBy     String
  status        String       @default("active")
  startsAt      DateTime     @default(now())
  endsAt        DateTime
  options       Json
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  comments      Comment[]
  votes         PollVote[]
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id])
  creator       User         @relation(fields: [createdBy], references: [id])

  @@index([cooperativeId, status])
  @@map("polls")
}

model PollVote {
  id       String   @id @default(uuid())
  pollId   String
  userId   String
  optionId String
  votedAt  DateTime @default(now())
  poll     Poll     @relation(fields: [pollId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([pollId, userId])
  @@index([pollId])
  @@map("poll_votes")
}

model AidProgram {
  id            String           @id @default(uuid())
  title         String
  description   String
  provider      String
  type          String
  eligibility   String
  deadline      DateTime?
  status        String           @default("open")
  cooperativeId String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  participants  AidParticipant[]
  cooperative   Cooperative?     @relation(fields: [cooperativeId], references: [id])

  @@index([cooperativeId, status])
  @@map("aid_programs")
}

model AidParticipant {
  id        String     @id @default(uuid())
  programId String
  userId    String
  status    String     @default("applied")
  appliedAt DateTime   @default(now())
  program   AidProgram @relation(fields: [programId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  @@unique([programId, userId])
  @@index([programId])
  @@map("aid_participants")
}

model Thread {
  id            String       @id @default(uuid())
  title         String
  content       String
  authorId      String
  cooperativeId String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  comments      Comment[]
  author        User         @relation(fields: [authorId], references: [id])
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id])

  @@index([cooperativeId])
  @@map("threads")
}

model Comment {
  id             String        @id @default(uuid())
  content        String
  authorId       String
  announcementId String?
  pollId         String?
  threadId       String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  announcement   Announcement? @relation(fields: [announcementId], references: [id])
  author         User          @relation(fields: [authorId], references: [id])
  poll           Poll?         @relation(fields: [pollId], references: [id])
  thread         Thread?       @relation(fields: [threadId], references: [id])

  @@index([announcementId])
  @@index([pollId])
  @@index([threadId])
  @@map("comments")
}

model Rating {
  id        String       @id @default(uuid())
  rating    Int
  comment   String?
  batchId   String
  createdAt DateTime     @default(now())
  batch     ProductBatch @relation(fields: [batchId], references: [id])

  @@index([batchId])
  @@map("ratings")
}

model Donation {
  id         String   @id @default(uuid())
  amount     Decimal
  currency   String   @default("USD")
  status     String   @default("pledged")
  farmerId   String
  donorName  String?
  donorEmail String?
  message    String?
  createdAt  DateTime @default(now())
  farmer     User     @relation(fields: [farmerId], references: [id])

  @@index([farmerId])
  @@map("donations")
}

enum UserRole {
  farmer
  agent
  ws
  factory
  exporter
  importer
  retailer
  admin
  qc
}

enum ProductType {
  coffee
  tea
}

enum SupplyChainStage {
  farmer
  washing_station
  factory
  exporter
  importer
  retailer
}

enum BatchStatus {
  pending
  approved
  rejected
  processing
  ready_for_export
  in_transit
  exported
  delivered
  completed
}

enum PaymentType {
  harvest_payment
  processing_payment
  export_payment
  quality_bonus
  other
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  cancelled
}

enum ReportType {
  monthly_summary
  quarterly_export
  annual_statistics
  quality_report
  payment_report
  custom
}

enum ReportStatus {
  draft
  submitted
  approved
  rejected
}

enum CertificateType {
  organic
  fair_trade
  quality_grade
  export_permit
  health_certificate
  origin_certificate
  other
}

enum AnnouncementType {
  general
  pricing
  aid
  training
  event
}

enum PollType {
  coffee_price
  tea_price
  aid_distribution
  general
}
